<script>
// index_js

document.addEventListener('DOMContentLoaded', () => {
  const loginSection = document.getElementById('login-section');
  const app = document.getElementById('app');
  const countSpan = document.getElementById('count');

  const token = localStorage.getItem('token');
  if (token) {
    loginSection.style.display = 'none';
    app.style.display = 'block';
    updateCount();
  }

  document.getElementById('login-button').addEventListener('click', () => {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    fetch(window.location.href, {
      method: 'POST',
      body: new URLSearchParams({ action: 'login', username, password })
    })
      .then(r => r.json())
      .then(data => {
        if (data.token) {
          localStorage.setItem('token', data.token);
          loginSection.style.display = 'none';
          app.style.display = 'block';
          updateCount();
        } else {
          alert('Login failed');
        }
      });
  });

  document.getElementById('send-button').addEventListener('click', () => {
    const token = localStorage.getItem('token');
    if (!token) return;
    fetch(window.location.href, {
      method: 'POST',
      body: new URLSearchParams({ action: 'sendEmails', token })
    })
      .then(r => r.json())
      .then(data => {
        alert('Emails sent: ' + data.sent);
        updateCount();
      });
  });

  function updateCount() {
    const token = localStorage.getItem('token');
    if (!token) return;
    fetch(window.location.href, {
      method: 'POST',
      body: new URLSearchParams({ action: 'getCount', token })
    })
      .then(r => r.json())
      .then(data => {
        countSpan.textContent = data.count;
      });
  }
});
</script>
